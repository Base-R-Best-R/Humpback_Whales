---
title: |
       | Humpback Whales and Ship Noise
author: "Fabian Blasch"
date: "`r format(Sys.Date(), format = '%m/%d/%Y')`"
header-includes:
   - \usepackage{amsmath}
   - \usepackage{amssymb}
   - \usepackage{float}
   - \usepackage{titling}
   - \usepackage{xcolor}
output: 
   pdf_document:
      number_sections: TRUE
bibliography: lit.bib
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.pos = "center",
                      fig.width = 8,
                      fig.height = 4,
                      fig.pos = "H",
                      out.extra = "")

# aux functions
source("Auxilliary.R")

# packages
get.package(c("ggplot2", "patchwork", "MASS", "stargazer", "nlme"))
```

\begin{center}
\includegraphics[width = 380pt]{pic.png} 
\end{center}
\thispagestyle{empty}
\newpage
\pagenumbering{arabic} 

# Data and Desciptive Statistics 

```{r}
# import data (this dataset is unfortunatelly not public)
openxlsx::read.xlsx("./../Data/Humpback_Whales_Data.xlsx") -> dat_whale

# fist a quick look at the missing values in the data
sapply(dat_whale,  \(x) sum(is.na(x))) |> knitr::kable(col.names = "NAs")

# harmonize names
colnames(dat_whale) <- tolower(colnames(dat_whale))

# to numeric
lapply(dat_whale[, c("ruhezeit", "speed", "atem")], as.numeric) -> dat_whale[, c("ruhezeit", "speed", "atem")]

# to factor
lapply(dat_whale[ ,!(colnames(dat_whale) %in%  c("ruhezeit", "speed", "atem"))], 
       as.factor) -> dat_whale[ ,!(colnames(dat_whale) %in%  c("ruhezeit", "speed", "atem"))]

# relevel 
factor(dat_whale[, "szenario"], 
       levels = c("Before", "During", "After")) -> dat_whale[, "szenario"] 
factor(dat_whale[, "treatment"], c("Control", "Medium", "High")) -> dat_whale[, "treatment"]

# add log
within(dat_whale,{
   logspeed <- log(speed)
   atem[atem == 0] <- 0.001
   ruhezeit[ruhezeit == 0] <- 0.001
   logatem <- log(atem)
   logruhezeit <- log(ruhezeit)
   sqrtatem <- sqrt(atem)
   sqrtspeed <- sqrt(speed)
   sqrtruhezeit <- sqrt(ruhezeit * 100)
}) -> dat_whale


# frist split into different intensities
dat_whale_intens <- split(dat_whale, dat_whale[, "treatment"]) 
```

```{r, fig.height = 11}
# build formulas
formulae <- paste(c("ruhezeit", "speed", "atem"), "~", "szenario")

# max and min for plot y-axis
sapply(c(min, max), \(x){
   
   sapply(dat_whale[, c("ruhezeit", "speed", "atem")], \(y) x(y, na.rm = TRUE))
   
   
}) -> ylims

# over szenarios
invis.Map(\(y, nom, lims){
   
   # safe for presentation
   # pdf(paste0("./../Presentation/", nom, ".pdf"))
   
   # align
   par(mfrow = c(3, 1), mar = c(2, 4, 4, 2) + 0.1)   
   
   # over treatment
   invis.Map(\(x, nom){
   
      # boxplots
      boxplot(as.formula(y), data = x, 
              col = c("cornflowerblue", "deepskyblue4", "darkblue"),
              ylim = c(lims[1], lims[2]))
      
      # add label
      mtext(nom, side = 3, line = 1, cex = 1.2)
      
   }, dat_whale_intens, names(dat_whale_intens))  
   
   # close graph. device
   # dev.off()
   
}, formulae, c("resting", "speed", "respatory"), ylims |> t() |> as.data.frame())

```

# Distribution of Covariates

```{r, warnings = FALSE, fig.height = 10}
# vars
nom <- c("ruhezeit", "speed", "atem")
nom <- c(nom, paste0("log", nom), paste0("sqrt", nom))

# loop to generate plots
lapply(nom, \(x) Dens_norm_plot(y = x)) -> plots

# display (remove useless bin width messages)
print((plots[[1]] + plots[[2]] + plots[[3]]) / 
      (plots[[4]] + plots[[5]] + plots[[6]]) / 
      (plots[[7]] + plots[[8]] + plots[[9]])) |> 
      suppressWarnings() |>
      suppressMessages()
```

# Model

```{r}
# formulas
formulae_lmm <- c("speed ~ I(treatment) * I(szenario)",
                  "atem ~ I(treatment) * I(szenario)",
                  "logspeed ~ I(treatment) * I(szenario)",
                  "sqrtatem ~ I(treatment) * I(szenario)")

formulae_glmm <- "ruhezeit ~ I(treatment) * I(szenario)"

# comb
formulae_cmb <- list(formulae_lmm, formulae_glmm)

# fit models
Map(\(type, bool){
   
   lapply(type, \(x){
      
      if(bool){ # LMMs
         
         # fit LMM
         nlme::lme(as.formula(x), random = ~ 1 | individuum,
                   data = dat_whale, na.action = na.omit,
                   method = "REML") -> fit
         
         # summary
         list(fit, 
              summary(fit))
         
      } else { # GLMMs
         
         # fit glmm PQL
         MASS::glmmPQL(as.formula(x), random = ~ 1 | individuum,
                       family = binomial(link = "logit"),
                       data = dat_whale) -> fit
         
         # summary
         list(fit, 
              summary(fit))
      }

   }) |> setNames(type)
   
}, formulae_cmb, c(TRUE, FALSE)) |> setNames(c("LMM", "GLMM")) -> models

# fits and summaries
LMM_fits <- lapply(models[[1]], "[[", 1)
LMM_summaries <- lapply(models[[1]], "[[", 2)
glmmPQL_fits <- lapply(models[[2]], "[[", 1)
glmmPQL_summaries <- lapply(models[[2]], "[[", 2)

# rebind fits for plotting
fits <- c(LMM_fits, glmmPQL_fits)
summaries <- c(LMM_summaries, glmmPQL_summaries)
```

# Residual Diagnostics

```{r, fig.height = 12}
# align
par(mfrow = c(5, 2), mar = c(2, 4, 4, 2) + 0.1) 

# residual plots
invis.Map(\(x, nom){
   
   invis.Map(\(y, col){
  
      # plots
      plot(x[["residuals"]][, y], type = "p", ylab = y, xlab = "", pch = 19,
           col = col)
      
      # label
      mtext(nom, side = 3, line = 1, cex = 1.2)
      
   }, c("fixed", "individuum"), c("cornflowerblue", "deepskyblue4"))
   
}, fits, c("Speed", "Breathe Freq.", "LogSpeed", "SqrtBreathe Freq.", "% Resting"))

# qqplots
par(mfrow = c(5, 2), mar = c(3.8, 4, 4, 2) + 0.1) 

# residual plots
invis.Map(\(x, nom){
   
   invis.Map(\(y, col){
  
      # plots
      qqnorm(x[["residuals"]][, y], pch = 19, col = col, main = "")
      
      # line
      qqline(x[["residuals"]][, y], col = "darkblue")
      
      # label
      mtext(paste(nom, "-", y), side = 3, line = 1, cex = 1.2)
      
   }, c("fixed", "individuum"), c("cornflowerblue", "deepskyblue4"))
   
}, fits, c("Speed", "Breathe Freq.", "LogSpeed", "SqrtBreathe Freq.", "% Resting"))
```

# Coefficients and t-Tests

```{r}
invis.lapply(names(summaries), \(x){
   
   # mods
   mod <- summaries[[x]][["tTable"]]
   
   # print table
   knitr::kable(mod)
}) |> setNames(names(summaries))
```




